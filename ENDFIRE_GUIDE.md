# エンドファイア型ビームフォーミング - セットアップガイド

## 📐 配置図

```
    話者A          左AirPods    右AirPods         話者B
      🗣️  ←--1m--→    ●  ←--50cm--→  ●  ←--1m--→  🗣️
    (出力対象)                                  (抑制対象)
```

**重要**: AirPodsは50cm離して一直線上に配置してください。

## 🎯 システムの仕組み

### エンドファイア型ビームフォーミングとは

一直線上に配置されたマイクアレイで、**軸方向の音源を選択的に強調**する技術です。

**原理:**
1. 左マイクの信号をそのまま使用
2. 右マイクの信号を遅延させて減算
3. A側から来る音は強調され、B側から来る音は打ち消される

**数式:**
```
遅延時間 τ = d / c = 0.50m / 343m/s ≈ 1.46ms

出力 = 左マイク - 0.5 × (右マイク を τ 遅延)
```

## 🚀 クイックスタート

### 1. セットアップ

```bash
# 仮想環境をアクティベート（既にセットアップ済みの場合）
source venv/bin/activate

# または初回セットアップ
./setup.sh
source venv/bin/activate
```

### 2. AirPodsの配置

1. **2つのAirPodsを用意**（左右のイヤホン）
2. **50cm離して一直線上に配置**
   - 定規やメジャーで正確に測定
   - 机の上に固定（動かないように）
3. **MacBookに接続**
   - システム環境設定 > サウンド > 入力 > AirPods

### 3. 話者の配置

```
A ←--約1m--→ 左AirPods ←--50cm--→ 右AirPods ←--約1m--→ B
```

- **話者A**: 左AirPodsの左側、約1m離れた位置
- **話者B**: 右AirPodsの右側、約1m離れた位置
- **一直線上に配置することが重要**

### 4. 実行

```bash
python endfire_beamforming.py
```

### 5. 設定入力

```
実行時間を入力してください（秒）:
（Enterキーのみで手動停止モード）
> [Enter]  # 手動停止モード

処理方法を選択してください:
1: 周波数領域（高品質・推奨）
2: 時間領域（超低遅延）
> 1
```

### 6. 動作確認

- 話者Aが話すと、MacBookスピーカーから音声が出力される
- 話者Bが話すと、音声が抑制される（ほとんど聞こえない）

## 🎛️ パラメータ調整

### マイク間距離の変更

実際の配置に合わせて調整:

```python
# endfire_beamforming.py の main() 関数内
beamformer = EndfireBeamformer(
    mic_distance=0.50,  # ← ここを実際の距離（メートル）に変更
)
```

**例:**
- 30cm離した場合: `mic_distance=0.30`
- 70cm離した場合: `mic_distance=0.70`
- 1m離した場合: `mic_distance=1.00`

### 話者Bを出力したい場合

```python
# endfire_beamforming.py の main() 関数内
beamformer = EndfireBeamformer(
    target_direction='right'  # 'left' → 'right' に変更
)
```

### 遅延を調整（低遅延重視）

```python
beamformer = EndfireBeamformer(
    block_size=1024,  # デフォルト: 2048
    # 遅延: 約21ms（デフォルトは約43ms）
)
```

### 減衰係数の調整

より強い抑制が必要な場合、`endfire_beamforming.py` の以下の部分を編集:

```python
# 時間領域版（約86行目）
output = left_channel - 0.5 * delayed_right
#                        ↑ 0.5 → 0.7 など大きくする

# 周波数領域版（約129行目）
weight_right = -0.5 * np.exp(-1j * phase_delay)
#               ↑ 0.5 → 0.7 など大きくする
```

## 📊 性能指標

### 処理遅延

| 処理方法 | ブロックサイズ | 理論遅延 | 実測遅延 |
|---------|--------------|---------|---------|
| 周波数領域 | 2048 | 43ms | 50-60ms |
| 時間領域 | 2048 | 43ms | 45-50ms |
| 周波数領域 | 1024 | 21ms | 25-30ms |
| 時間領域 | 1024 | 21ms | 23-28ms |

### 分離性能

**理想的な条件下:**
- 話者Aの音声: 0dB（そのまま）
- 話者Bの音声: -15dB〜-20dB（大幅に抑制）

**実際の環境:**
- 反響がある場合: -10dB〜-15dB
- 話者が一直線から外れている場合: -5dB〜-10dB

## 🔧 トラブルシューティング

### ❌ 話者Bの音声が抑制されない

**原因と解決策:**

1. **配置がずれている**
   ```
   ✗ 悪い例:
       A
        \
         左●---●右
                 \
                  B
   
   ✓ 良い例:
   A---左●---●右---B
   ```
   → 一直線上に配置し直す

2. **マイク間距離が不正確**
   ```bash
   # 実際の距離を測定して設定
   mic_distance=0.52  # 実測52cmの場合
   ```

3. **減衰係数が小さい**
   ```python
   # 0.5 → 0.7 に変更
   output = left_channel - 0.7 * delayed_right
   ```

### ❌ 音声が歪む

**原因と解決策:**

1. **音量が大きすぎる**
   - 話者とマイクの距離を離す（1.5m〜2m）
   - MacBookの出力音量を下げる

2. **ブロックサイズが小さすぎる**
   ```python
   block_size=2048  # 1024から増やす
   ```

### ❌ 遅延が大きい

**解決策:**

1. **時間領域処理を使用**
   ```
   処理方法を選択してください:
   > 2  # 時間領域
   ```

2. **ブロックサイズを小さくする**
   ```python
   block_size=1024  # または 512
   ```

### ❌ ノイズが多い

**解決策:**

1. **静かな環境で使用**
   - エアコンやファンを止める
   - 窓を閉める

2. **ノイズリダクションを強化**
   
   `endfire_beamforming.py` の `apply_noise_reduction()` を編集:
   ```python
   # ハイパスフィルタのカットオフを上げる
   sos = signal.butter(4, 150, 'hp', ...)  # 100 → 150
   ```

## 💡 使用例

### 例1: インタビュー

```
インタビュアー(A) ←→ 左● ←50cm→ ●右 ←→ ゲスト(B)
```

**設定:**
```python
target_direction='left'  # インタビュアーの声を出力
```

**用途:** インタビュアーの質問のみを録音・配信

### 例2: 会議

```
発表者(A) ←→ 左● ←50cm→ ●右 ←→ 聴衆(B)
```

**設定:**
```python
target_direction='left'  # 発表者の声を出力
```

**用途:** 発表者の声を明瞭に聞く

### 例3: 通訳

```
日本語話者(A) ←→ 左● ←50cm→ ●右 ←→ 英語話者(B)
```

**設定:**
```python
target_direction='left'  # 日本語話者の声を出力
# または
target_direction='right'  # 英語話者の声を出力
```

**用途:** 特定の言語の話者のみを聞く

## 📈 最適化のヒント

### 1. 距離の最適化

**マイク間距離と周波数特性:**

| 距離 | 最適周波数帯域 | 用途 |
|-----|--------------|------|
| 30cm | 1kHz - 8kHz | 高音質・近距離 |
| 50cm | 500Hz - 6kHz | バランス型（推奨） |
| 100cm | 200Hz - 4kHz | 低音重視・遠距離 |

### 2. 話者距離の最適化

```
最適距離 = マイク間距離 × 2

例: マイク間50cm → 話者は1m離れる
```

### 3. 環境の最適化

- **床**: カーペットより硬い床の方が良い
- **壁**: 反響を抑えるため、カーテンやクッションを配置
- **天井**: 低い天井より高い天井の方が良い

## 🎓 技術的な詳細

### エンドファイアビームパターン

```
        抑制
         ↑
         |
    -----●-----●----- メインローブ（強調）
         |
         ↓
        抑制
```

**指向性:**
- メインローブ幅: 約±30度
- サイドローブレベル: -10dB〜-15dB
- フロント/バック比: 15dB〜20dB

### 周波数特性

```
利得 (dB)
  0  |     _______________
     |    /
 -10 |   /
     |  /
 -20 | /
     |/________________
     0   500  1k  2k  4k  8k  (Hz)
     
低域: 徐々に減衰
中域: フラット（500Hz-4kHz）
高域: 徐々に減衰
```

## 📝 次のステップ

1. **基本動作確認**: 5秒間のテスト実行
2. **配置の最適化**: 話者位置を調整して最良の分離を見つける
3. **パラメータ調整**: 減衰係数や距離を微調整
4. **実用テスト**: 実際の使用シーンで長時間テスト

---

**🎉 準備完了！**

まずは短時間（10-30秒）でテストして、配置とパラメータを最適化してください。
