# ビームフォーミング方式の比較

このディレクトリには2つの異なるビームフォーミング実装があります。

## 📊 2つの方式の比較

### 1. ブロードサイド型（beam_forming.py）

**配置:**
```
        話者1
         🗣️
        /
       /  -45°
      /
    ●─────────● (AirPods)
      \
       \  +45°
        \
         🗣️
        話者2
```

**特徴:**
- マイクアレイに対して**垂直方向**の音源を分離
- 2人の話者が**左右**に分かれている場合に最適
- マイク間距離: 15cm（AirPods装着時の耳間距離）
- 出力: 2つのWAVファイル（speaker1, speaker2）

**用途:**
- 対談・ディスカッション
- 左右に座った2人の会議
- ステレオ録音が必要な場合

---

### 2. エンドファイア型（endfire_beamforming.py）

**配置:**
```
A ←---→ 左● ←--50cm--→ ●右 ←---→ B
```

**特徴:**
- マイクアレイに対して**軸方向**の音源を選択
- 2人の話者が**前後**（一直線上）に分かれている場合に最適
- マイク間距離: 50cm（自由に設定可能）
- 出力: リアルタイムでMacBookスピーカーから再生

**用途:**
- インタビュー（質問者と回答者）
- プレゼンテーション（発表者と聴衆）
- 特定の話者のみを聞きたい場合

---

## 🎯 どちらを使うべきか？

### ブロードサイド型を使う場合

✅ **こんな時に使う:**
- 2人が横並び（左右）に座っている
- 両方の話者の音声を別々に録音したい
- AirPodsを装着して使いたい
- 後から編集・分析したい

❌ **向いていない:**
- リアルタイムで聞きたい
- 1人の音声だけ必要
- マイク間距離を広げたい

**実行方法:**
```bash
python beam_forming.py
```

---

### エンドファイア型を使う場合

✅ **こんな時に使う:**
- 2人が前後（一直線上）に位置している
- 特定の1人の音声だけ聞きたい
- リアルタイムで音声を聞きたい
- マイク間距離を自由に設定したい（30cm〜1m）

❌ **向いていない:**
- 両方の話者を同時に録音したい
- 話者が左右に分かれている
- AirPodsを装着して使いたい

**実行方法:**
```bash
python endfire_beamforming.py
```

---

## 📐 配置例

### シナリオ1: 対談（ブロードサイド型）

```
     話者A        話者B
       🗣️          🗣️
        \          /
         \        /
          ●──────●
        (あなた + AirPods)
```

**使用:** `beam_forming.py`

**出力:**
- `speaker1_left_*.wav` - 話者Aの音声
- `speaker2_right_*.wav` - 話者Bの音声

---

### シナリオ2: インタビュー（エンドファイア型）

```
質問者 ←→ 左● ←--50cm--→ ●右 ←→ ゲスト
 🗣️                              🗣️
```

**使用:** `endfire_beamforming.py`

**出力:**
- リアルタイムでMacBookスピーカーから質問者の音声
- または、設定変更でゲストの音声

---

### シナリオ3: 会議（ブロードサイド型）

```
    参加者A          参加者B
      🗣️              🗣️
       \              /
        \            /
         ●──────────●
      (議事録係 + AirPods)
```

**使用:** `beam_forming.py`

**出力:**
- 各参加者の発言を別々に記録
- 後で文字起こしや分析が可能

---

### シナリオ4: プレゼン（エンドファイア型）

```
発表者 ←→ 左● ←--50cm--→ ●右 ←→ 聴衆
 🗣️                              🗣️🗣️🗣️
```

**使用:** `endfire_beamforming.py`

**出力:**
- 発表者の声のみをクリアに聞く
- 聴衆のノイズを抑制

---

## ⚙️ 技術的な違い

| 項目 | ブロードサイド型 | エンドファイア型 |
|-----|----------------|----------------|
| **配置** | 左右（垂直） | 前後（軸方向） |
| **マイク間距離** | 15cm（固定） | 30cm〜1m（可変） |
| **処理方式** | オフライン録音 | リアルタイム |
| **出力** | WAVファイル×2 | スピーカー出力 |
| **遅延** | なし | 50-100ms |
| **分離性能** | 中程度 | 高い |
| **アルゴリズム** | Delay-Sum / MVDR | Endfire |
| **計算量** | 中〜高 | 低〜中 |

---

## 🚀 クイックスタート

### 初めて使う場合

1. **セットアップ（初回のみ）**
   ```bash
   ./setup.sh
   source venv/bin/activate
   ```

2. **配置を決める**
   - 左右配置 → ブロードサイド型
   - 前後配置 → エンドファイア型

3. **テストを実行**
   
   **ブロードサイド型:**
   ```bash
   python test_devices.py
   python beam_forming.py
   ```
   
   **エンドファイア型:**
   ```bash
   python test_endfire.py
   python endfire_beamforming.py
   ```

---

## 📚 ドキュメント

### ブロードサイド型
- **クイックスタート**: `QUICKSTART.md`
- **詳細マニュアル**: `README.md`
- **技術解説**: `TECHNICAL.md`
- **テストスクリプト**: `test_devices.py`

### エンドファイア型
- **セットアップガイド**: `ENDFIRE_GUIDE.md`
- **テストスクリプト**: `test_endfire.py`

---

## 🔧 パラメータ調整

### ブロードサイド型

```python
# beam_forming.py
beamformer = AirPodsBeamformer(
    sample_rate=48000,
    block_size=4096,
    mic_distance=0.15,  # 15cm（固定）
)

# 話者の角度
self.angles = np.array([-45, 45])  # 左右45度
```

### エンドファイア型

```python
# endfire_beamforming.py
beamformer = EndfireBeamformer(
    sample_rate=48000,
    block_size=2048,     # 低遅延
    mic_distance=0.50,   # 50cm（調整可能）
    target_direction='left'  # A側を出力
)
```

---

## 💡 よくある質問

### Q1: 両方を同時に使えますか？

A: いいえ。AirPodsは1つの入力デバイスとしてしか認識されないため、同時には使えません。

### Q2: ブロードサイド型でリアルタイム出力できますか？

A: 可能ですが、現在の実装は録音・保存に特化しています。必要であれば改造できます。

### Q3: エンドファイア型で2人とも録音できますか？

A: 現在は1人のみですが、コードを修正すれば両方向のビームフォーミングを同時に実行できます。

### Q4: マイク間距離を変えるとどうなりますか？

A: 
- **広い（50cm〜1m）**: 低周波の分離性能向上、高い指向性
- **狭い（10cm〜20cm）**: 高周波の分離性能向上、広い指向性

### Q5: どちらが高性能ですか？

A: 用途によります：
- **分離性能**: エンドファイア型（一直線配置の場合）
- **汎用性**: ブロードサイド型
- **低遅延**: エンドファイア型（時間領域処理）
- **録音品質**: ブロードサイド型（MVDR使用時）

---

## 🎓 次のステップ

1. **まずテスト**: 短時間（5-10秒）で動作確認
2. **配置最適化**: 話者位置を調整して最良の結果を得る
3. **パラメータ調整**: 距離や角度を微調整
4. **実用テスト**: 実際のシーンで長時間テスト
5. **カスタマイズ**: 必要に応じてコードを改造

---

**選択に迷ったら:**
- **録音したい** → ブロードサイド型
- **リアルタイムで聞きたい** → エンドファイア型
