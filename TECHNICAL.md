# AirPods ビームフォーミングシステム - 技術解説

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    AirPods (入力デバイス)                      │
│                                                             │
│   左マイク ◄────────┐         ┌────────► 右マイク            │
│                    │         │                             │
└────────────────────┼─────────┼─────────────────────────────┘
                     │         │
                     ▼         ▼
            ┌─────────────────────────┐
            │   ステレオ音声入力       │
            │   (2チャンネル)         │
            └───────────┬─────────────┘
                        │
                        ▼
            ┌─────────────────────────┐
            │  リアルタイム処理ループ  │
            │  (ブロックサイズ: 4096)  │
            └───────────┬─────────────┘
                        │
                        ▼
            ┌─────────────────────────┐
            │   FFT (周波数領域変換)   │
            └───────────┬─────────────┘
                        │
                ┌───────┴───────┐
                ▼               ▼
    ┌──────────────────┐  ┌──────────────────┐
    │ ビームフォーミング │  │ ビームフォーミング │
    │   方向: -45度    │  │   方向: +45度    │
    │   (左側の話者)   │  │   (右側の話者)   │
    └────────┬─────────┘  └────────┬─────────┘
             │                     │
             ▼                     ▼
    ┌──────────────────┐  ┌──────────────────┐
    │  IFFT (時間領域)  │  │  IFFT (時間領域)  │
    └────────┬─────────┘  └────────┬─────────┘
             │                     │
             ▼                     ▼
    ┌──────────────────┐  ┌──────────────────┐
    │  話者1の音声     │  │  話者2の音声     │
    │  (左側)          │  │  (右側)          │
    └────────┬─────────┘  └────────┬─────────┘
             │                     │
             ▼                     ▼
    ┌──────────────────┐  ┌──────────────────┐
    │  WAVファイル保存  │  │  WAVファイル保存  │
    │  speaker1_*.wav  │  │  speaker2_*.wav  │
    └──────────────────┘  └──────────────────┘
```

## ビームフォーミングの原理

### 空間配置

```
                    話者1 (左側)
                        🗣️
                       /
                      /  -45°
                     /
        左マイク ●─────────────● 右マイク
        (AirPods)   15cm    (AirPods)
                     \
                      \  +45°
                       \
                        🗣️
                    話者2 (右側)
```

### 信号処理フロー

#### 1. Delay-and-Sum Beamforming

```
入力信号:
  Left:  s_L(t) = s_1(t - τ_1L) + s_2(t - τ_2L) + n_L(t)
  Right: s_R(t) = s_1(t - τ_1R) + s_2(t - τ_2R) + n_R(t)

ステアリングベクトル (角度θ):
  a(θ, f) = [e^(-jπf·d·sin(θ)/c), e^(jπf·d·sin(θ)/c)]

出力信号:
  y(f) = a^H(θ, f) · x(f) / 2

  where:
    - τ: 時間遅延
    - s_1, s_2: 話者1, 2の音声
    - n: ノイズ
    - d: マイク間距離 (0.15m)
    - c: 音速 (343 m/s)
    - f: 周波数
    - ^H: エルミート転置
```

#### 2. MVDR Beamforming

```
共分散行列:
  R = E[x(f) · x^H(f)]

MVDRウェイト:
  w_MVDR = (R^(-1) · a(θ, f)) / (a^H(θ, f) · R^(-1) · a(θ, f))

出力信号:
  y(f) = w_MVDR^H · x(f)

特徴:
  - 目的方向の信号を歪みなく通過
  - 他の方向からの干渉を最小化
  - より高い分離性能
```

## 周波数応答特性

### 角度分解能

```
マイク間距離 d = 0.15m の場合:

周波数 (Hz) | 波長 (m) | 角度分解能 (度)
------------|----------|----------------
  1,000     |  0.343   |     ±30
  2,000     |  0.172   |     ±15
  4,000     |  0.086   |     ±8
  8,000     |  0.043   |     ±4

※ 角度分解能 ≈ arcsin(λ / 2d)
```

### ビームパターン

```
         0°
         ↑
    -30° | +30°
      \  |  /
       \ | /
        \|/
  -90°───●───+90°
        /|\
       / | \
      /  |  \
   -150°|+150°
         ↓
        180°

メインローブ幅: 約60度 @ 2kHz
サイドローブレベル: -10dB 程度
```

## パフォーマンス指標

### 処理遅延

```
ブロックサイズ: 4,096 サンプル
サンプリングレート: 48,000 Hz

理論遅延 = 4,096 / 48,000 = 85.3 ms

実際の遅延:
  - Delay-and-Sum: 約 90-100 ms
  - MVDR: 約 100-120 ms
```

### メモリ使用量

```
1秒あたりのデータ量:
  - 入力: 48,000 samples/s × 2 channels × 4 bytes = 384 KB/s
  - 出力: 48,000 samples/s × 2 speakers × 4 bytes = 384 KB/s
  - 合計: 約 768 KB/s

10秒録音時のメモリ:
  - 約 7.68 MB
```

## 最適化のヒント

### 1. マイク間距離の調整

```python
# より広い間隔（例: ヘッドセット）
beamformer = AirPodsBeamformer(mic_distance=0.20)  # 20cm

# より狭い間隔（例: イヤホン）
beamformer = AirPodsBeamformer(mic_distance=0.10)  # 10cm
```

### 2. 角度の最適化

```python
# 話者が前方に集中している場合
self.angles = np.array([-30, 30])

# 話者が左右に大きく離れている場合
self.angles = np.array([-60, 60])

# 前後の話者を分離
self.angles = np.array([0, 180])
```

### 3. ブロックサイズの調整

```python
# 低遅延（リアルタイム性重視）
beamformer = AirPodsBeamformer(block_size=2048)  # 約43ms

# 高品質（周波数分解能重視）
beamformer = AirPodsBeamformer(block_size=8192)  # 約171ms
```

## 実装の詳細

### クラス構造

```
AirPodsBeamformer
├── __init__()              # 初期化
├── list_audio_devices()    # デバイス一覧
├── select_airpods_device() # AirPods選択
├── calculate_steering_vector() # ステアリングベクトル計算
├── delay_and_sum_beamforming() # 遅延和BF
├── mvdr_beamforming()      # MVDR BF
├── audio_callback()        # オーディオコールバック
├── process_audio_stream()  # リアルタイム処理
├── save_separated_audio()  # 音声保存
└── visualize_separation()  # 可視化
```

### データフロー

```
1. 音声入力 (sounddevice)
   ↓
2. キューイング (queue.Queue)
   ↓
3. チャンネル分離
   ↓
4. FFT変換 (scipy.fft)
   ↓
5. ビームフォーミング
   ↓
6. IFFT変換
   ↓
7. バッファリング
   ↓
8. ファイル保存 (soundfile)
```

## トラブルシューティングフローチャート

```
AirPodsが検出されない
    ↓
┌───────────────────┐
│ Bluetooth接続確認 │
└────────┬──────────┘
         │ OK
         ↓
┌───────────────────┐
│ 入力デバイス設定  │
│ (システム環境設定)│
└────────┬──────────┘
         │ OK
         ↓
┌───────────────────┐
│ test_devices.py   │
│ を実行            │
└────────┬──────────┘
         │ 検出成功
         ↓
┌───────────────────┐
│ beam_forming.py   │
│ を実行            │
└───────────────────┘


音声が分離されない
    ↓
┌───────────────────┐
│ 話者の位置確認    │
│ (左右に分離?)     │
└────────┬──────────┘
         │ OK
         ↓
┌───────────────────┐
│ 角度パラメータ調整│
│ self.angles       │
└────────┬──────────┘
         │ OK
         ↓
┌───────────────────┐
│ MVDR手法を試す    │
└────────┬──────────┘
         │ OK
         ↓
┌───────────────────┐
│ マイク間距離調整  │
│ mic_distance      │
└───────────────────┘
```

## 参考: 音響パラメータ

### 音速と周波数の関係

```
音速 c = 343 m/s (20°C, 海面)

波長 λ = c / f

周波数 (Hz) | 波長 (m)
------------|----------
    100     |  3.43
    500     |  0.686
  1,000     |  0.343
  2,000     |  0.172
  4,000     |  0.086
  8,000     |  0.043
 16,000     |  0.021
```

### 人間の音声特性

```
基本周波数:
  - 男性: 100-150 Hz
  - 女性: 200-250 Hz
  - 子供: 250-350 Hz

フォルマント周波数:
  - F1: 300-1,000 Hz
  - F2: 800-2,500 Hz
  - F3: 2,000-3,500 Hz

音声帯域: 300-3,400 Hz (電話品質)
          50-8,000 Hz (高品質)
```
