# AirPods Dual-Microphone Beamforming for Speaker Separation

AirPodsの左右のマイクを使用して、2人の話者を空間的に分離するビームフォーミングシステムです。

## 📋 概要

このシステムは、AirPodsの左右のマイクから入力された音声を使用して、異なる方向から話している2人の話者を分離します。ビームフォーミング技術を使用して、各話者の音声を個別に抽出し、WAVファイルとして保存できます。

## 🎯 主な機能

- **リアルタイム話者分離**: AirPodsの左右マイクから同時に音声を取得し、リアルタイムで処理
- **2つのビームフォーミングアルゴリズム**:
  - **Delay-and-Sum (遅延和)**: 高速で安定した処理
  - **MVDR**: より高精度な分離（計算量は大きい）
- **自動デバイス検出**: AirPodsを自動的に検出
- **音声ファイル出力**: 分離された各話者の音声をWAVファイルとして保存
- **可視化機能**: 波形とスペクトログラムで分離結果を確認

## 🔧 技術的な仕組み

### ビームフォーミングの原理

1. **空間的フィルタリング**: 左右のマイク間の時間差を利用して、特定の方向からの音声を強調
2. **ステアリングベクトル**: 各周波数で目的方向に対する位相遅延を計算
3. **周波数領域処理**: FFTで周波数領域に変換し、各周波数ビンで独立に処理

### パラメータ

- **サンプリングレート**: 48,000 Hz（高品質音声）
- **ブロックサイズ**: 4,096 サンプル（約85ms）
- **マイク間距離**: 0.15m（AirPods装着時の左右耳間の距離）
- **想定角度**: 
  - 話者1: -45度（左側）
  - 話者2: +45度（右側）

## 📦 インストール

### 必要な環境

- macOS
- Python 3.7以上
- AirPods（または2チャンネル入力可能なマイク）

### セットアップ

```bash
# 1. セットアップスクリプトを実行
./setup.sh

# 2. 仮想環境をアクティベート
source venv/bin/activate
```

### 手動インストール

```bash
# 仮想環境を作成
python3 -m venv venv
source venv/bin/activate

# 依存関係をインストール
pip install -r requirements.txt
```

## 🚀 使用方法

### 基本的な使い方

1. **AirPodsを接続**
   - AirPodsをMacBookに接続
   - システム環境設定 > サウンド > 入力で、AirPodsを選択

2. **スクリプトを実行**
   ```bash
   python beam_forming.py
   ```

3. **設定を入力**
   - 録音時間を入力（Enterのみで手動停止モード）
   - ビームフォーミング手法を選択（1: Delay-and-Sum, 2: MVDR）

4. **録音開始**
   - 2人が左右に分かれて話す
   - 手動停止モードの場合は Ctrl+C で停止

5. **結果の確認**
   - 分離された音声が `speaker1_left_YYYYMMDD_HHMMSS.wav` と `speaker2_right_YYYYMMDD_HHMMSS.wav` として保存されます
   - オプションで可視化も可能

### 使用例

```bash
# 仮想環境をアクティベート
source venv/bin/activate

# プログラムを実行
python beam_forming.py

# 出力例:
# ============================================================
# AirPods Dual-Microphone Beamforming
# 話者分離システム
# ============================================================
# 
# === 利用可能なオーディオデバイス ===
# [0] MacBook Pro Microphone
#     入力チャンネル数: 1
#     サンプリングレート: 48000.0 Hz
# 
# [1] AirPods Pro
#     入力チャンネル数: 2
#     サンプリングレート: 48000.0 Hz
# 
# AirPodsを検出しました: AirPods Pro
# 
# 録音時間を入力してください（秒）:
# （Enterキーのみで手動停止モード）
# > 10
# 
# ビームフォーミング手法を選択してください:
# 1: Delay-and-Sum（遅延和）- 高速・安定
# 2: MVDR - 高精度・計算量大
# > 1
```

## 📊 出力ファイル

### 音声ファイル

- `speaker1_left_YYYYMMDD_HHMMSS.wav`: 左側の話者の分離音声
- `speaker2_right_YYYYMMDD_HHMMSS.wav`: 右側の話者の分離音声

### 可視化ファイル（オプション）

- `separation_result_YYYYMMDD_HHMMSS.png`: 波形とスペクトログラム

## 🎛️ カスタマイズ

### パラメータの調整

`beam_forming.py` の `main()` 関数内で以下のパラメータを調整できます:

```python
beamformer = AirPodsBeamformer(
    sample_rate=48000,      # サンプリングレート
    block_size=4096,        # 処理ブロックサイズ
    mic_distance=0.15       # マイク間距離（メートル）
)
```

### 話者の角度を変更

`AirPodsBeamformer` クラスの `__init__` メソッド内:

```python
self.angles = np.array([-45, 45])  # [話者1の角度, 話者2の角度]
```

例:
- より広い角度: `[-60, 60]`
- 前方と後方: `[0, 180]`
- 左前と右前: `[-30, 30]`

## 🔬 アルゴリズムの詳細

### 1. Delay-and-Sum Beamforming

**特徴**:
- シンプルで高速
- 安定した動作
- リアルタイム処理に適している

**動作原理**:
1. 各マイクの信号をFFTで周波数領域に変換
2. 目的方向に対するステアリングベクトルを計算
3. ステアリングベクトルと入力信号の内積を計算
4. IFFTで時間領域に戻す

### 2. MVDR (Minimum Variance Distortionless Response)

**特徴**:
- より高精度な分離
- 干渉抑制能力が高い
- 計算量が大きい

**動作原理**:
1. 入力信号の共分散行列を推定
2. 共分散行列の逆行列を計算
3. MVDRウェイトを計算: `w = R^(-1) * a / (a^H * R^(-1) * a)`
4. ウェイトと入力信号の内積を計算

## 📈 性能と制限事項

### 性能

- **処理遅延**: 約85ms（ブロックサイズ4096サンプル時）
- **周波数範囲**: 20Hz - 24kHz
- **分離性能**: 話者間の角度が大きいほど良好

### 制限事項

1. **マイク間距離**: AirPodsの左右耳間の距離（約15cm）に依存
2. **角度分解能**: マイク間距離が小さいため、角度分解能は限定的
3. **話者の位置**: 話者が左右に明確に分かれている必要がある
4. **反響**: 反響の多い環境では性能が低下
5. **移動**: 話者が移動すると分離性能が低下

### 最適な使用環境

- 静かな室内
- 話者が左右に約90度以上離れている
- 話者とマイクの距離が1-3m程度
- 反響の少ない環境

## 🛠️ トラブルシューティング

### AirPodsが検出されない

1. AirPodsがMacBookに接続されているか確認
2. システム環境設定 > サウンド > 入力で、AirPodsが選択されているか確認
3. プログラムを再起動

### 音声が分離されない

1. 話者が左右に十分離れているか確認
2. マイク間距離パラメータを調整
3. 話者の角度パラメータを調整
4. MVDRアルゴリズムを試す

### ノイズが多い

1. 録音環境を静かにする
2. ブロックサイズを大きくする（8192など）
3. 後処理でノイズ除去フィルタを追加

## 📚 参考文献

- Van Veen, B. D., & Buckley, K. M. (1988). "Beamforming: A versatile approach to spatial filtering"
- Benesty, J., Chen, J., & Huang, Y. (2008). "Microphone Array Signal Processing"
- Brandstein, M., & Ward, D. (2001). "Microphone Arrays: Signal Processing Techniques and Applications"

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 貢献

バグ報告や機能リクエストは、GitHubのIssueで受け付けています。

## 📧 お問い合わせ

質問や提案がある場合は、GitHubのIssueまたはPull Requestでお知らせください。

---

**注意**: このシステムは研究・教育目的で作成されています。商用利用の場合は、適切なライセンスを確認してください。
